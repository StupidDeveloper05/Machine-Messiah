<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>md viewer</title>

    <link href="/static/stylesheets/style.css" rel="stylesheet">
    <link href="/static/stylesheets/prism.css" rel="stylesheet" />
	<link href="/static/stylesheets/github-markdown.css" rel="stylesheet">

    <script src="/static/js/browser/diffDOM.js"></script>
    <script src="/static/js/prism.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/remarkable/1.7.1/remarkable.min.js"></script>
    <script>
        function copyBtn(e) {
            window.navigator.clipboard.writeText(e.parentNode.childNodes[1].innerText);
            e.innerText="copied!";
            setTimeout(function(){e.innerText="copy"}, 1000);
        }
        function mdtohtml(row_text){
            const md = new Remarkable();
            return md.render(row_text);
        }
        function applyPrism(element) {
            element.find("code").each(function(index, item) {
                var text = item.innerText;
                Prism.highlightElement(item);
                if (item.parentNode.tagName == "PRE") {
                    var btn = $('<button onclick="copyBtn(this);">copy</button>')[0];
                    item.parentNode.parentNode.childNodes[1].append(btn);
                    var copyText = $('<div class="copyText" style="display:none"></div>').text(text);
                    item.parentNode.parentNode.childNodes[1].append(copyText[0]);
                }
            });
            element.find("code").removeClass('language-none');
        }
        function applyDiffDOM(element) {
            var arr = document.getElementsByClassName("markdown-body");
            var dd = new diffDOM.DiffDOM();
            var diff = dd.diff(arr[arr.length - 1], element.get(0));
            dd.apply(arr[arr.length - 1], diff);
        }
        var isBottom = true;
        window.addEventListener("scroll", function(){
            isBottom = window.innerHeight + Math.round(window.scrollY) >= document.body.offsetHeight;
        });
        var sock = io.connect("http://" + document.domain + ":" + location.port);
        function run_program(e) {
            sock.emit("run_program", e.value);
        }
        document.addEventListener("DOMContentLoaded", function(){
            sock.on('message', function(msg){
                if (msg.uuid == "{{UUID|safe}}")
                {
                    if(msg.type === 'assistant'){
                        if (msg.status === 'running'){
                            var content = $('<div class="markdown-body">').html(mdtohtml(msg.msg));
                            applyPrism(content);
                            applyDiffDOM(content);
                        }
                        else if (msg.status === 'start'){
                            var content = $('<div class="chatting-card-assistant"><div class="markdown-body">'+ mdtohtml(msg.msg) +'</div></div>');
                            applyPrism(content);
                            $('#chatList').append(content);
                        }
                        $('a').attr('target', '_blank');
                    } 
                    else if (msg.type === 'user') {
                        $('#chatList').append($('<div class="right-align">').append($('<div class="chatting-card-user">').append($('<pre class="anti-xss-pre">').text(msg.msg))));
                    }
                    else if (msg.type === "function") {
                        var json = JSON.parse(msg.msg);
                        var content = $('<div class="chatting-card-assistant"><div class="markdown-body"></div></div>');
                        for (key in json) {
                            var btn = $('<button class="run-program-button" onclick="run_program(this)" value="' + json[key][1] + '">');
                            var box = $('<div class="run-program-box">');
                            box.append( $('<img src="' + '/static/img/' + json[key][0] + '.png' + '" width=96 height=96>'));
                            box.append($('<p class="run-program-title">' + json[key][0] + '</p>'));
                            btn.append(box);
                            content.append(btn);
                        }
                        if (msg.status === 'running'){
                            var con = $(".markdown-body").last();
                            con.html(content.html());
                        }
                        else{
                            $('#chatList').append(content);
                        }
                    }
                    else if (msg.type === "clear_until_user") {
                        var children = $("#chatList").children();
                        for (var i = children.length - 1; i >= 0; --i) {
                            if (children[i].classList.contains('chatting-card-assistant')) {
                                children[i].remove();
                            } 
                            else {
                                break;
                            }
                        }
                    }
                    if (isBottom)
                        window.scrollTo({top: $("#chatList").prop('scrollHeight')});
                    console.log('Received Message : ' + msg.type);
                }
            });
        });
    </script>
</head>
<body>
    <div id="chatList"></div>    
    <script>
        var arr = {{Data|tojson}};
        arr.forEach((list, index) => {
            if (list[0] == "assistant") {
                var content = $('<div class="chatting-card-assistant"><div class="markdown-body">'+ mdtohtml(list[1]) +'</div></div>');
                $('#chatList').append(content);
            }
            else if (list[0] == "user") {
                $('#chatList').append($('<div class="right-align">').append($('<div class="chatting-card-user">').append($('<pre class="anti-xss-pre">').text(list[1]))));
            }
            else if (list[0] == "function") {
                var json = JSON.parse(list[1]);
                var content = $('<div class="chatting-card-assistant"><div class="markdown-body"></div></div>');
                for (key in json) {
                    var btn = $('<button class="run-program-button" onclick="run_program(this)" value="' + json[key][1] + '">');
                    var box = $('<div class="run-program-box">');
                    box.append( $('<img src="' + '/static/img/' + json[key][0] + '.png' + '" width=96 height=96>'));
                    box.append($('<p class="run-program-title">' + json[key][0] + '</p>'));
                    btn.append(box);
                    content.append(btn);
                }
                $('#chatList').append(content);
            }
        });
        $("code").each(function(index, item) {
            var text = item.innerText;
            Prism.highlightElement(item);
            if (item.parentNode.tagName == "PRE") {
                var btn = $('<button onclick="copyBtn(this);">copy</button>')[0];
                item.parentNode.parentNode.childNodes[1].append(btn);
                var copyText = $('<div class="copyText" style="display:none"></div>').text(text);
                item.parentNode.parentNode.childNodes[1].append(copyText[0]);
            }
        });
        $("code").removeClass('language-none');
        $('a').attr('target', '_blank');
        window.scrollTo({top: $("#chatList").prop('scrollHeight')});
    </script>
</body>
</html>